name: go to log-in page

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-24.04

    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Python 3.12ë¡œ ì„¸íŒ… (ë¡œì»¬ê³¼ ë™ì¼)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ê°€ìƒí™˜ê²½ ìƒì„± ë° ì˜ì¡´ì„± íŒŒì¼ ì„¤ì¹˜
      - name: Set up virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
      - name: Install Playwright browsers
        run: |
          source venv/bin/activate
          playwright install --with-deps chromium

      # pytest ì‹¤í–‰, HTML ë¦¬í¬íŠ¸ ìƒì„±
      - name: Run pytest with HTML report
        run: |
          source venv/bin/activate
          rm -f report_login_page.html
          python -m pytest tests/main_page.py --html=report_login_page.html --self-contained-html

      # HTML ë¦¬í¬íŠ¸ë¥¼ GitHub Actions Artifactsë¡œ ì—…ë¡œë“œ
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-html-report
          path: report_login_page.html

      # Slackìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•Œë¦¼ ì „ì†¡ (ìƒì„¸ ê²°ê³¼ì— ëŒ€í•´ì„  ì•Œë ¤ì¤„ ìˆ˜ ì—†ìŒ)
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
        # url ì„¸íŒ…ì´ ì•ˆë˜ì–´ ìˆê±°ë‚˜ ì˜ëª»ë˜ì–´ ìˆìœ¼ë©´ ë
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "need setting url."
            exit 0
          fi

          if [ "$JOB_STATUS" = "success" ]; then
            STATUS_EMOJI="ğŸ˜€"
            STATUS_TEXT="ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì„±ê³µ"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          fi

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"$STATUS_EMOJI Playwright ìë™í™” í…ŒìŠ¤íŠ¸ ê²°ê³¼\n- ìƒíƒœ: $STATUS_TEXT\n- Repository: ${{ github.repository }}\n- Branch: ${{ github.ref_name }}\"
          }" \
          $SLACK_WEBHOOK_URL
